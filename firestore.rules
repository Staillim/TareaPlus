
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isAdmin() {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isUser() {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user';
    }
    
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      
      allow create: if request.auth != null && request.auth.uid == userId
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.email == request.auth.token.email
                    && request.resource.data.username is string
                    && request.resource.data.username.size() >= 3
                    && request.resource.data.createdAt == request.time
                    && request.resource.data.role == 'user'
                    && request.resource.data.referralCode is string
                    && request.resource.data.referralCode.size() == 8;

      allow update: if isOwner(userId)
                    && request.resource.data.username == request.resource.data.username; // Allow username updates

      // Admin can update any user's fields, for moderation for example
      allow update: if isAdmin();

      // Subcolección de historial de tareas completadas
      match /completedTasksHistory/{historyId} {
        allow read, create: if isOwner(userId);
        allow list: if isOwner(userId) || isAdmin();
        allow update, delete: if isAdmin();
      }

      // Subcolección de canjes
      match /redemptions/{redemptionId} {
        allow read, create: if isOwner(userId);
        allow list: if isOwner(userId);
        // El administrador puede actualizar el estado (aprobar/rechazar)
        allow update: if isAdmin();
        allow delete: if isAdmin();
      }
    }
    
    // Consulta de grupo para canjes (para administradores)
    match /{path=**}/redemptions/{redemptionId} {
      allow read: if isAdmin();
    }

    match /tasks/{taskId} {
      allow read: if request.auth != null; // Todos los usuarios autenticados pueden leer tareas
      allow list: if request.auth != null;
      allow create, update, delete: if isAdmin();
    }

    match /rewards/{rewardId} {
        allow read, list: if request.auth != null;
        allow create, update, delete: if isAdmin();
    }

    match /referrals/{referralId} {
      allow read, create: if request.auth != null;
    }
  }
}
